image: ubuntu:latest

before_script:
  - apt update
  - export LLVM_INCLUDE_PATH=$(llvm-config --includedir)
  - export CMAKE_PREFIX_PATH=$(llvm-config --libdir)/cmake/llvm

stages:
  - deploy
  - analyze
  - test

pages:
  stage: deploy
  script:
    - mkdir public
    - cp -r documentation/html/* public/
  artifacts:
    paths:
      - public
  rules:
    - if: '$CI_COMMIT_REF_NAME == "Plugins"'

analyze:
  stage: analyze
  script:
    - apt install -y llvm libopenmpi-dev clang #g++
    - find src selector -name "*.cpp" -exec clang --analyze -I$LLVM_INCLUDE_PATH -Iqdmi/ {} \;

testing:
  stage: test
  script:
    - apt install -y cmake llvm libopenmpi-dev g++ #clang
    # ...
    - cd qdmi
    - mkdir build
    - cd build
    - cmake ..
    - make
    - echo QDMI built successfully
    # ...
    - cd ../../selector
    - mkdir build
    - cd build
    - cmake -DCUSTOM_EXECUTABLE_NAME=qselectorrunner_d ..
    - cmake --build .
    - echo Selector Runner built successfully
    - cd ../../tests
    # ...
    - mpic++ -std=c++14 test.cpp -o test
    - echo Test built successfully
    - cd ../build
    - mkdir build
    - cd build
    - cmake -DCUSTOM_EXECUTABLE_NAME=qpassrunner_d -DCUSTOM_QDMI_PATH=qdmi ..
    - cmake --build .
    - echo Pass Runner built successfully
    # ...
    - ./qpassrunner_d &
    - sleep 1
    - cd ../selector/build/
    - ./qselectorrunner_d &
    - sleep 1
    - ../../tests/test

